<!DOCTYPE html>




<html class="theme-next mist" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<meta name="google-site-verification" content="OPbdC3XgTof4tFEWC2tht4eHDM4r4ibJbRVf-cFF104" />



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
    
  
  <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="reactnatiev," />










<meta name="description" content="热更新是一个非常方便的方案。在应对大量用户和深度定制的时候一定不能使用开源的方案。一般第三方的这种方案，服务器带宽较小，或者不够灵活，不能满足自己的想法。这里推荐自己实现对应的热更新方案。只需要少量代码即可支持。下面推荐一种灵活的热更新方案。包括客户端的改造、接口设计、界面开发，同时是开源的！可以自由改造。  体验地址：demo  用户名密码都是：admin  基础数据的准备和实现首先第一点，一">
<meta name="keywords" content="reactnatiev">
<meta property="og:type" content="article">
<meta property="og:title" content="ReactNative热更新系统">
<meta property="og:url" content="http://www.guofangchao.com/2019/08/21/ReactNative热更新系统/index.html">
<meta property="og:site_name" content="IT技术博客">
<meta property="og:description" content="热更新是一个非常方便的方案。在应对大量用户和深度定制的时候一定不能使用开源的方案。一般第三方的这种方案，服务器带宽较小，或者不够灵活，不能满足自己的想法。这里推荐自己实现对应的热更新方案。只需要少量代码即可支持。下面推荐一种灵活的热更新方案。包括客户端的改造、接口设计、界面开发，同时是开源的！可以自由改造。  体验地址：demo  用户名密码都是：admin  基础数据的准备和实现首先第一点，一">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://images.gitbook.cn/1f547740-c1c8-11e9-8621-c1fbe3716b21">
<meta property="og:image" content="https://images.gitbook.cn/a6d25b80-c1c6-11e9-97a8-35dcf136a505">
<meta property="og:image" content="https://images.gitbook.cn/be731340-c222-11e9-b09c-0b1079e2bca5">
<meta property="og:image" content="https://images.gitbook.cn/e1a0da90-c223-11e9-8848-37e0885470ed">
<meta property="og:image" content="https://images.gitbook.cn/1e7472b0-c224-11e9-b09c-0b1079e2bca5">
<meta property="og:image" content="https://images.gitbook.cn/738d2840-c225-11e9-b09c-0b1079e2bca5">
<meta property="og:image" content="https://images.gitbook.cn/ec972e20-c225-11e9-8848-37e0885470ed">
<meta property="og:image" content="https://images.gitbook.cn/aa87e7d0-c226-11e9-971d-f913fcb779b2">
<meta property="og:image" content="https://images.gitbook.cn/68bbbda0-c22a-11e9-9271-07e402cbd35b">
<meta property="og:image" content="https://images.gitbook.cn/14812880-c228-11e9-b09c-0b1079e2bca5">
<meta property="og:image" content="https://images.gitbook.cn/2b17dd30-c22a-11e9-9271-07e402cbd35b">
<meta property="og:image" content="https://images.gitbook.cn/71521da0-c22b-11e9-9271-07e402cbd35b">
<meta property="og:image" content="https://images.gitbook.cn/b3910a00-c22b-11e9-9271-07e402cbd35b">
<meta property="og:image" content="https://images.gitbook.cn/d27d28a0-c22f-11e9-9271-07e402cbd35b">
<meta property="og:image" content="https://images.gitbook.cn/6644bb70-c230-11e9-a11c-2f548b53168d">
<meta property="og:updated_time" content="2019-08-21T08:48:27.328Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ReactNative热更新系统">
<meta name="twitter:description" content="热更新是一个非常方便的方案。在应对大量用户和深度定制的时候一定不能使用开源的方案。一般第三方的这种方案，服务器带宽较小，或者不够灵活，不能满足自己的想法。这里推荐自己实现对应的热更新方案。只需要少量代码即可支持。下面推荐一种灵活的热更新方案。包括客户端的改造、接口设计、界面开发，同时是开源的！可以自由改造。  体验地址：demo  用户名密码都是：admin  基础数据的准备和实现首先第一点，一">
<meta name="twitter:image" content="https://images.gitbook.cn/1f547740-c1c8-11e9-8621-c1fbe3716b21">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.guofangchao.com/2019/08/21/ReactNative热更新系统/"/>





  <title>ReactNative热更新系统 | IT技术博客</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?643d73884f29a250f12d991eaf23e1d7";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">IT技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">一个技术人的实验室</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.guofangchao.com/2019/08/21/ReactNative热更新系统/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="郭方超">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ReactNative热更新系统</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-21T16:48:00+08:00">
                2019-08-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/big-front-end/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/21/ReactNative热更新系统/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/08/21/ReactNative热更新系统/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>热更新是一个非常方便的方案。在应对大量用户和深度定制的时候一定不能使用开源的方案。<br>一般第三方的这种方案，服务器带宽较小，或者不够灵活，不能满足自己的想法。<br>这里推荐自己实现对应的热更新方案。只需要少量代码即可支持。<br>下面推荐一种灵活的热更新方案。包括客户端的改造、接口设计、界面开发，同时是开源的！可以自由改造。</p>
</blockquote>
<p>体验地址：<a href="http://bundle.guofangchao.com/" target="_blank" rel="noopener">demo</a>  用户名密码都是：admin</p>
<p><img src="https://images.gitbook.cn/1f547740-c1c8-11e9-8621-c1fbe3716b21" alt="关键数据"></p>
<h3 id="基础数据的准备和实现"><a href="#基础数据的准备和实现" class="headerlink" title="基础数据的准备和实现"></a>基础数据的准备和实现</h3><p>首先第一点，一个APP如果要支持热更新，需要在打开APP（或者其他进入RN页面之前）就要判断是否需要更新bundle文件。这里就是我们实现热更新的节点。一旦需要热更新就开始下载文件，而判断的接口就是我们这次文章的核心内容。这里简单贴出安卓和ios两端的下载逻辑。</p>
<blockquote>
<p>请求之前需要在head中附带上客户端的几个重要信息。客户端版本号version、客户端唯一id:clientid、客户端类型platform、客户端品牌brand。</p>
</blockquote>
<p>ios下载的例子<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)doCheckUpdate</span><br><span class="line">&#123;</span><br><span class="line">  self.upView.viewButtonStart.hidden = YES;</span><br><span class="line">  <span class="keyword">if</span> ([XCUploadManager isFileExist:[XCUploadManager bundlePathUrl].path])</span><br><span class="line">  &#123;<span class="comment">//沙盒里已经有了下载好的jsbundle，以沙盒文件优先</span></span><br><span class="line">    self.oldSign = [FileHash md5HashOfFileAtPath:[XCUploadManager bundlePathUrl].path];</span><br><span class="line">  &#125;<span class="keyword">else</span></span><br><span class="line">  &#123;<span class="comment">//真机计算出的包内bundlemd5有变化，可能是压缩了，所以这里写死初始化的md5</span></span><br><span class="line">    <span class="comment">//    NSString *ipPath = [[NSBundle mainBundle] pathForResource:@"main" ofType:@"jsbundle"];</span></span><br><span class="line">    <span class="comment">//    self.oldSign = [FileHash md5HashOfFileAtPath:ipPath];</span></span><br><span class="line">    self.oldSign = projectBundleMd5;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  AFHTTPSessionManager *_sharedClient = [[AFHTTPSessionManager alloc] initWithBaseURL:[NSURL URLWithString:@<span class="string">"http://test.com"</span>]];</span><br><span class="line">  </span><br><span class="line">  [self initAFNetClient:_sharedClient];</span><br><span class="line"></span><br><span class="line">  [_sharedClient GET:@<span class="string">"api/check"</span> parameters:nil progress:nil success:^(NSURLSessionDataTask * __unused task, id JSON) &#123;</span><br><span class="line">    NSDictionary *dic = [JSON valueForKeyPath:@<span class="string">"data"</span>];</span><br><span class="line">    BOOL isNeedLoadBundle = YES;</span><br><span class="line">    <span class="keyword">if</span> ([dic isKindOfClass:[NSDictionary class]])</span><br><span class="line">    &#123;</span><br><span class="line">      self.updateSign = [dic stringForKey:@<span class="string">"sign"</span>];</span><br><span class="line">      self.downLoadUrl = [dic stringForKey:@<span class="string">"downloadUrl"</span>];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(self.updateSign.length &amp;&amp; self.oldSign.length &amp;&amp; (![self.updateSign isEqualToString:self.oldSign]))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">//需要更新bundle文件了</span></span><br><span class="line">        self.upView.viewUpdate.hidden = NO;</span><br><span class="line">        [self updateBundleNow];</span><br><span class="line">        isNeedLoadBundle = NO;</span><br><span class="line">      &#125;<span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">//不需要更新bundle文件，再处理跳过按钮显示逻辑</span></span><br><span class="line">        [self.upView showSkipButtonOrNot];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isNeedLoadBundle) &#123;</span><br><span class="line">      [self loadBundle];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; failure:^(NSURLSessionDataTask *__unused task, NSError *error) &#123;</span><br><span class="line">    [self loadBundle];</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>安卓下载的例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">requestData</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        subscribe = DalingNetwork</span><br><span class="line">                .getDalingApi()</span><br><span class="line">                .getBundleVersion()</span><br><span class="line">                .subscribeOn(Schedulers.io())</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(<span class="keyword">new</span> BaseSubscriber&lt;BundleVersionResponse&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                        startMainActivity();</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(<span class="keyword">final</span> BundleVersionResponse response)</span> </span>&#123;</span><br><span class="line">                        isJSNeedUpdate = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">if</span> (response.status == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (response.data != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (MainApplication.getApplication().getBundleMD5().equalsIgnoreCase(response.data.sign)) &#123;</span><br><span class="line">                                    <span class="comment">//和本地版本相同，直接进入主页</span></span><br><span class="line">                                    isJSNeedUpdate = <span class="keyword">false</span>;</span><br><span class="line">                                    tv_skip.setVisibility(View.VISIBLE);</span><br><span class="line">                                    startMainActivity();</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="comment">//下载升级</span></span><br><span class="line">                                    isJSNeedUpdate = <span class="keyword">true</span>;</span><br><span class="line">                                    downloadSign = response.data.sign;</span><br><span class="line">                                    downloadUrl = response.data.downloadUrl;</span><br><span class="line">                                    downLoad(response.data.downloadUrl, response.data.sign);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            startMainActivity();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="系统设计方案"><a href="#系统设计方案" class="headerlink" title="系统设计方案"></a>系统设计方案</h3><p>首先来看一下我们是怎样设计客户端获取更新逻辑的。<br><img src="https://images.gitbook.cn/a6d25b80-c1c6-11e9-97a8-35dcf136a505" alt="更新逻辑"></p>
<ol>
<li>客户端请求的时候会带上版本号、平台2个重要信息。</li>
<li>接口拿到请求之后查询对应的本地缓存，没有则去数据库查询。</li>
<li>从查询结果中筛查对应的3段数据：白名单、灰度、全量，判断顺序从左到右。</li>
<li>返回查询之后对应的结果。</li>
</ol>
<h3 id="数据库等设计"><a href="#数据库等设计" class="headerlink" title="数据库等设计"></a>数据库等设计</h3><p>上面的设计是基础的逻辑，下面我们继续细化逻辑。其中为了支持更好的性能和分布式做了一些其他的方案设计。</p>
<p><em>根据逻辑自行设计是完全可以的😁</em></p>
<h5 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h5><p>我们选择MySQL作为基础数据库，负责存储每次发布之后的数据保存。<br><img src="https://images.gitbook.cn/be731340-c222-11e9-b09c-0b1079e2bca5" alt="数据库设计"><br><code>fe_bundle</code>表存储的是每次发布的bundle信息，主要分3个部分：</p>
<ol>
<li>表本身需要的数据。id、状态、操作人、发布说明。</li>
<li>判断是否更新的依据字段。版本号、平台、客户端id、bundle的签名、地址、压缩包的地址。</li>
<li>作为附加数据在接口返回的。标签id、标签内容。</li>
</ol>
<p><code>fe_labels</code>表就是作为附加数据存储的。如果想要在接口上返回一些复杂的操作，比如显示隐藏某个界面、是否加载某个bundle、是否强制更新等，都可以在这里设置。这个表本身只支持添加和是否启用，不支持删除，防止误操作。</p>
<blockquote>
<p>根据实际情况减少字段的长度可以优化数据库的查询性能。比如昵称的长度不会超过10个字符。<br>大量数据的情况下添加索引也会提高数据库性能。查询的时候只查询需要的字段也可以减少查询的时间。</p>
</blockquote>
<h5 id="发布订阅设计"><a href="#发布订阅设计" class="headerlink" title="发布订阅设计"></a>发布订阅设计</h5><p>使用发布订阅模式主要是为了同步每次发布的结果。这样做可以解耦发布和本地缓存更新，多个服务器支持也不会出现资源争夺或者更新不及时的情况。</p>
<p>这里使用的是redis的发布订阅模式，可以选的其他方案有MQ的消息队列等方式。在收到消息的时候主动更新本地缓存。<br><img src="https://images.gitbook.cn/e1a0da90-c223-11e9-8848-37e0885470ed" alt="发布订阅"><br><img src="https://images.gitbook.cn/1e7472b0-c224-11e9-b09c-0b1079e2bca5" alt="发布消息"></p>
<h5 id="本地缓存设计"><a href="#本地缓存设计" class="headerlink" title="本地缓存设计"></a>本地缓存设计</h5><p>接口响应速度快不快的关键就是在本地缓存这里了。毕竟在用户大量访问的情况下，一个数据库是非常难支撑的。这里利用本地缓存减少数据库的查询，不管是面对多少用户，实际在工作的就只有接口所在的服务器线程。而且这里利用了nodejs的高并发优势，只要机器抗的住，我们的服务就不会卡顿或者挂掉。服务能支持的并发数几乎等于机器支持的并发数。</p>
<ol>
<li>本地缓存的优点就是查询速度快，没有网络请求的消耗。</li>
<li>在遇到缓存没有的情况下，去数据库读取数据并缓存在本地。</li>
<li>使用双缓存，避免多个请求来临的情况下并发打垮数据库。</li>
<li><p>双缓存只是应对特殊情况，比如本地缓存失效、服务器重启等情况下的大量请求。正常情况下发布订阅已经解决了本地缓存的问题。<br><img src="https://images.gitbook.cn/738d2840-c225-11e9-b09c-0b1079e2bca5" alt="本地缓存策略"></p>
<h3 id="前台界面开发"><a href="#前台界面开发" class="headerlink" title="前台界面开发"></a>前台界面开发</h3><p>前台界面使用React+Mobx+ElementUI实现。这里选择这个技术栈主要是为了方便，毕竟会RN的开发者大概率是可以很快上手React的。</p>
</li>
<li><p>React作为基础框架，利用框架的优势快速开发。</p>
</li>
<li>Mobx作为状态管理，这次项目中只利用到了用户信息的全局管理。</li>
<li>ElementUI的几个UI还不错，这里利用现成的UI开发，剩下大量的设计精力。</li>
</ol>
<h5 id="登录界面"><a href="#登录界面" class="headerlink" title="登录界面"></a>登录界面</h5><p>登录只需要简单的一个背景+登录信息输入框即可。有兴趣的可以优化一下，让界面更好看。<br><img src="https://images.gitbook.cn/ec972e20-c225-11e9-8848-37e0885470ed" alt="登录"><br>这里利用Mobx将用户的登录信息保存在全局缓存中。这个设计比较简陋，在公司内部用一下还可以了。如果是开发给更多人用一定要完善一下，把用户鉴权做的更安全一些。<br><img src="https://images.gitbook.cn/aa87e7d0-c226-11e9-971d-f913fcb779b2" alt="登录判断"></p>
<h5 id="bundle管理界面"><a href="#bundle管理界面" class="headerlink" title="bundle管理界面"></a>bundle管理界面</h5><p>列表管理只需要显示关键信息即可。列出查询的几个参数，方便查询。在点击删除的时候要弹出是否删除的提示，点击发布的时候也需要弹出提示。<br><img src="https://images.gitbook.cn/68bbbda0-c22a-11e9-9271-07e402cbd35b" alt="bundle管理"><br>编辑的时候给出几个固定选项。如果是灰度的时候还能够选择不同的手机品牌、灰度的比例。如果是白名单模式，需要填入白名单对应的clientid。<br><img src="https://images.gitbook.cn/14812880-c228-11e9-b09c-0b1079e2bca5" alt="发布管理"></p>
<h5 id="标签管理"><a href="#标签管理" class="headerlink" title="标签管理"></a>标签管理</h5><p>标签的核心就是添加和使用。在添加的时候定义好添加的字段和值类型。只需要一次添加即可完成。客户端兼容🈚️值情况下的兼容就好了。<br><img src="https://images.gitbook.cn/2b17dd30-c22a-11e9-9271-07e402cbd35b" alt="标签"></p>
<h3 id="后端接口开发"><a href="#后端接口开发" class="headerlink" title="后端接口开发"></a>后端接口开发</h3><p>接口分2个部分，一部分是应对后台的编辑列表等接口，另外一个部分是应对大量用户的查询接口。</p>
<h5 id="编辑查询接口"><a href="#编辑查询接口" class="headerlink" title="编辑查询接口"></a>编辑查询接口</h5><p>接口开发其实非常简单，如果对数据库使用不熟练的可以看看相应的文档或者教程。<br><a href="https://guofangchao.com/2018/08/09/%E4%BD%BF%E7%94%A8Sequelize%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93/" target="_blank" rel="noopener">sequelize简单教程</a></p>
<p>接口开发3个步骤：</p>
<ol>
<li>获取请求的参数。这里最好添加默认值处理，异常校验。</li>
<li>查询数据库。处理正常返回和catch报错的2种情况。</li>
<li>按照约定的规范返回具体的内容。</li>
</ol>
<blockquote>
<p>这里约定，返回<code>status=0</code>是查询成功，所有数据放在<code>data</code>字段里。<br>返回<code>status=1</code>代表查询失败，错误信息放在<code>msg</code>字段里。</p>
</blockquote>
<p><img src="https://images.gitbook.cn/71521da0-c22b-11e9-9271-07e402cbd35b" alt="接口1"><br><img src="https://images.gitbook.cn/b3910a00-c22b-11e9-9271-07e402cbd35b" alt="接口2"></p>
<h5 id="查询接口"><a href="#查询接口" class="headerlink" title="查询接口"></a>查询接口</h5><p>查询接口分2个线程，一个线程是网络请求线程，管理来访的网络请求和筛选返回。另外一个线程管理本地更新，通过redis的订阅模式触发对应的数据更新。</p>
<h6 id="缓存更新"><a href="#缓存更新" class="headerlink" title="缓存更新"></a>缓存更新</h6><p>当redis通知到需要更新的时候会带上版本号、平台的数据库。我们本地缓存也是由这2个字段作为key缓存的。<br><img src="https://images.gitbook.cn/d27d28a0-c22f-11e9-9271-07e402cbd35b" alt="缓存更新"><br><code>searchFromService</code>这个方法主要是从数据库拿对应的数据列表，并且在拿到数据之后手工把数据分为3个部分，分别用来处理白名单、灰度、全量的数据。他们对应的返回也是N个白名单、N个灰度、1个全量数据。</p>
<h6 id="网络请求"><a href="#网络请求" class="headerlink" title="网络请求"></a>网络请求</h6><p>网络请求逻辑较复杂，需要首先从缓存中拿数据，同时可能触发数据库拿数据并处理到缓存中，备份缓存拿数据并返回。<br><img src="https://images.gitbook.cn/6644bb70-c230-11e9-a11c-2f548b53168d" alt="查询缓存"><br>数据来源确定之后就开始分阶段筛选。</p>
<ol>
<li>筛选是否存在合适的白名单数据。</li>
<li>筛选是否存在合适的灰度数据</li>
<li>判断对应的全量数据是否存在。</li>
</ol>
<p>以上判断全部完成之后就可以知道本次请求是否有合适的bundle了。没有的话客户端也不需要更新。用户可以正常打开并浏览。</p>
<blockquote>
<p>判断灰度的时候clientid中可能会带字母。这情况下需要将字母转为数据再判断。<br>这里的转化是简单的字母数字对应，具体表现就是百分比前移。前60%的用户量会大于后40%的用户量。如果对这个有要求的可以按照26进制转10进制的方式转化数据。拿到的就是真实的百分比了。</p>
</blockquote>
<h3 id="源代码地址"><a href="#源代码地址" class="headerlink" title="源代码地址"></a>源代码地址</h3><p>前台页面地址：<a href="https://github.com/cuo9958/pub-web" target="_blank" rel="noopener">前台代码</a></p>
<p>后台接口地址：<a href="https://github.com/cuo9958/pub-server" target="_blank" rel="noopener">后台代码</a></p>
<p>数据库地址：<a href="https://github.com/cuo9958/pub-service" target="_blank" rel="noopener">数据库代码</a></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>请支持我一下吧.</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wxzs.jpeg" alt="郭方超 微信支付"/>
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/reactnatiev/" rel="tag"># reactnatiev</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/05/05/获取git当前分支名/" rel="next" title="获取git当前分支名">
                <i class="fa fa-chevron-left"></i> 获取git当前分支名
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/02/24/优化centos系统/" rel="prev" title="优化centos系统">
                优化centos系统 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="SOHUCS"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="郭方超" />
            
              <p class="site-author-name" itemprop="name">郭方超</p>
              <p class="site-description motion-element" itemprop="description">全栈工程师/产品经理/游戏开发</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">50</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/cuo9958" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:545570335@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/fangchao.guo" target="_blank" title="FB Page">
                      
                        <i class="fa fa-fw fa-facebook"></i>FB Page</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ezo.biz/" title="小猪的博客" target="_blank">小猪的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://pengrl.com/" title="yoko blog" target="_blank">yoko blog</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#基础数据的准备和实现"><span class="nav-number">1.</span> <span class="nav-text">基础数据的准备和实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统设计方案"><span class="nav-number">2.</span> <span class="nav-text">系统设计方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据库等设计"><span class="nav-number">3.</span> <span class="nav-text">数据库等设计</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#数据库设计"><span class="nav-number">3.0.1.</span> <span class="nav-text">数据库设计</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#发布订阅设计"><span class="nav-number">3.0.2.</span> <span class="nav-text">发布订阅设计</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#本地缓存设计"><span class="nav-number">3.0.3.</span> <span class="nav-text">本地缓存设计</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前台界面开发"><span class="nav-number">4.</span> <span class="nav-text">前台界面开发</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#登录界面"><span class="nav-number">4.0.1.</span> <span class="nav-text">登录界面</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#bundle管理界面"><span class="nav-number">4.0.2.</span> <span class="nav-text">bundle管理界面</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#标签管理"><span class="nav-number">4.0.3.</span> <span class="nav-text">标签管理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#后端接口开发"><span class="nav-number">5.</span> <span class="nav-text">后端接口开发</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#编辑查询接口"><span class="nav-number">5.0.1.</span> <span class="nav-text">编辑查询接口</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询接口"><span class="nav-number">5.0.2.</span> <span class="nav-text">查询接口</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#缓存更新"><span class="nav-number">5.0.2.1.</span> <span class="nav-text">缓存更新</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#网络请求"><span class="nav-number">5.0.2.2.</span> <span class="nav-text">网络请求</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源代码地址"><span class="nav-number">6.</span> <span class="nav-text">源代码地址</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">郭方超</span>

  
</div>








<div>
  <a href="http://beian.miit.gov.cn/">京ICP备14044836号-4</a>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'JVfh8Anp0UMvaxLASDflkRGG-gzGzoHsz',
        appKey: 'mMoiWejqJwBDcku0FIuKXMYy',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
